image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 3072

pipelines:
  branches:
    main:
      - step:
          name: Deploy to EC2
          deployment: production
          script:
            # Deploy to EC2 using Bitbucket's SSH key
            - echo "Deploying to EC2 instance..."
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $EC2_USER
                SERVER: $EC2_HOST
                COMMAND: |
                  set -e
                  cd /home/$USER/devops-tool || mkdir -p /home/$USER/devops-tool && cd /home/$USER/devops-tool
                  
                  # Pull latest code
                  echo "Pulling latest code from Bitbucket..."
                  if [ -d ".git" ]; then
                    git pull origin main
                  else
                    git clone https://rotimio@bitbucket.org/curaceldev/devops-tool.git .
                  fi
                  
                  # Stop existing containers
                  echo "Stopping existing containers..."
                  docker-compose down || true
                  
                  # Build and start services
                  echo "Building and starting services..."
                  docker-compose build
                  docker-compose up -d
                  
                  # Wait for services to be ready
                  echo "Waiting for services to start..."
                  sleep 30
                  
                  # Health check
                  echo "Running health checks..."
                  docker-compose ps
                  
                  # Show logs
                  docker-compose logs --tail=50
                  
                  echo "✓ Deployment completed successfully!"
                  echo "✓ Application running on port 5080"
            
            - echo "Deployment to EC2 completed!"

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - docker
        script:
          - echo "Testing Docker build..."
          - docker-compose build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          script:
            - echo "Testing Docker build..."
            - docker-compose build
            - echo "✓ Build successful!"
