image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 3072

pipelines:
  branches:
    main:
      - step:
          name: Deploy to EC2
          deployment: production
          script:
            # Setup SSH
            - echo "Setting up SSH connection..."
            - mkdir -p ~/.ssh
            - echo $SSH_KEY | base64 -d > ~/.ssh/id_rsa
            - chmod 600 ~/.ssh/id_rsa
            - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
            
            # Deploy to EC2
            - echo "Deploying to EC2 instance..."
            - |
              ssh $EC2_USER@$EC2_HOST << 'ENDSSH'
                set -e
                cd /home/$USER/devops-tool || mkdir -p /home/$USER/devops-tool
                
                # Pull latest code
                echo "Pulling latest code from Bitbucket..."
                if [ -d ".git" ]; then
                  git pull origin main
                else
                  git clone https://rotimio@bitbucket.org/curaceldev/devops-tool.git .
                fi
                
                # Stop existing containers
                echo "Stopping existing containers..."
                docker-compose down || true
                
                # Build and start services
                echo "Building and starting services..."
                docker-compose build
                docker-compose up -d
                
                # Wait for services to be ready
                echo "Waiting for services to start..."
                sleep 30
                
                # Health check
                echo "Running health checks..."
                docker-compose ps
                
                # Show logs
                docker-compose logs --tail=50
                
                echo "✓ Deployment completed successfully!"
                echo "✓ Application running on port 5080"
              ENDSSH
            
            - echo "Deployment to EC2 completed!"

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - docker
        script:
          - echo "Testing Docker build..."
          - docker-compose build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          script:
            - echo "Testing Docker build..."
            - docker-compose build
            - echo "✓ Build successful!"
