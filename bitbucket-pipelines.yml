image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 3072

pipelines:
  branches:
    main:
      - step:
          name: Deploy to EC2
          deployment: production
          script:
            # Deploy to EC2 using Bitbucket's SSH key
            - echo "Deploying to EC2 instance..."
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $EC2_USER
                SERVER: $EC2_HOST
                COMMAND: |
                  set -e
                  
                  # Define project directory
                  PROJECT_DIR="$HOME/devops-tool"
                  
                  # Create directory if it doesn't exist
                  if [ ! -d "$PROJECT_DIR" ]; then
                    echo "Creating project directory..."
                    mkdir -p "$PROJECT_DIR"
                    cd "$PROJECT_DIR"
                    
                    # Clone repository
                    echo "Cloning repository..."
                    git clone https://rotimio@bitbucket.org/curaceldev/devops-tool.git .
                  else
                    echo "Project directory exists, pulling latest changes..."
                    cd "$PROJECT_DIR"
                    
                    # Pull latest code
                    git pull origin main
                  fi
                  
                  # Stop existing containers
                  echo "Stopping existing containers..."
                  docker-compose down || true
                  
                  # Build and start services
                  echo "Building and starting services..."
                  docker-compose build
                  docker-compose up -d
                  
                  # Wait for services to be ready
                  echo "Waiting for services to start..."
                  sleep 30
                  
                  # Health check
                  echo "Running health checks..."
                  docker-compose ps
                  
                  # Show logs
                  echo "Recent logs:"
                  docker-compose logs --tail=50
                  
                  echo "✓ Deployment completed successfully!"
                  echo "✓ Application running on port 5080"
            
            - echo "Deployment to EC2 completed!"

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - docker
        script:
          - echo "Testing Docker build..."
          - docker-compose build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          script:
            - echo "Testing Docker build..."
            - docker-compose build
            - echo "✓ Build successful!"
